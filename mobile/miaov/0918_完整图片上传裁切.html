<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>完整图片上传裁切</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <style>
        *{margin:0;
            padding:0;}
        body{
            background: #f4f4f4;
        }

        /*上传框*/
        @media (min-width:1px){
            .box{
                width: 80%;
                margin: 20px auto;
                text-align: center;
            }
            label{
                display: inline-block;
                width: 100px;
                height: 30px;
                line-height: 30px;
                font-size: 14px;
                background: #424242;
                color: #ffffff;
            }
            input{
                display: none;
                width: 150px;
                border: 1px solid #dddddd;
                background: #f4f4f4;
            }
            .submit{
                width: 100px;
                height: 30px;
                line-height: 30px;
                margin: 0 auto;
                text-align: center;
                background: #006ecd;
                color: #ffffff;
            }
        }

        .imgBox{
            width: 200px;
            min-height: 20px;
            margin: 20px auto;
            border: 1px solid #dddddd;
            background: #dedede;
            text-align: center;
        }
        .imgBox img{
            max-width: 100%;
            vertical-align: top;
        }
        #editCanvas{
            /*display: none;*/
            background: #ffffff;
        }
    </style>
</head>
<body>
<!--上传图片要实现功能：-->
<!--1. 预览-->
<!--2. 编辑&#45;&#45;裁切框拖动放大缩小-->
<!--3. 编辑&#45;&#45;图片双指放大缩小-->
<!--4. 编辑&#45;&#45;图片和裁切框单指拖动-->
<!--5. 裁切完毕保存图片-->
<div class="box">
    <label for="file">选择图片</label>
    <input type="file" accept="image/png" name="file" id="file">
    <!--<div class="submit">编辑</div>-->
</div>

<canvas id="editCanvas" height="300px"></canvas>
<div class="imgBox"></div>

<script src="zytouch.js"></script>
<script>
        var imgbox = document.querySelector(".imgBox");
        onlyDrag({
            el: imgbox
        });
    window.onresize = function(e){
        myCanvas.width = window.innerWidth;
    };

//    (function(){
        var file = document.getElementById("file");
        var myCanvas = document.getElementById("editCanvas");
        var ctx = myCanvas.getContext('2d');
        myCanvas.width = window.innerWidth;

//    选择要上传图片后，进行处理
        file.onchange = function(e){
            var reader = new FileReader();
            reader.readAsDataURL(this.files[0]);
            reader.onload = function(e){
                var img = new Image();
                img.src = e.target.result;
                img.onload = function(){
                    render(img, myCanvas);
                }
            }
        };
//    })();


//  把图片渲染进canvas
    function  render(img, canvas){
        var wScale, hScale; // 图片宽高和canvas宽高的比例
        var initImgPos = {};// 图片在canvas上的渲染位置
        var curImgPos = {};
        wScale = img.width/canvas.width;
        hScale = img.height/canvas.height;
        if(Math.max(wScale, hScale) > 1){
            if(wScale > hScale){
                img.width = canvas.width;
                img.height = Math.ceil(img.height/wScale);
            }else{
                img.height  = canvas.height;
                img.width = Math.ceil(img.width/hScale)
            }
        }
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, (canvas.width-img.width)/2, (canvas.height-img.height)/2, img.width, img.height);
        initImgPos = {
            x: (canvas.width-img.width)/2,
            y: (canvas.height-img.height)/2,
            scale: 1
        };


//        单指拖动图片
        singleDrag({
            el: canvas,
            move: function(e){
               curImgPos.x = e.change.x + initImgPos.x;
               curImgPos.y = e.change.y + initImgPos.y;
               ctx.clearRect(0, 0, canvas.width, canvas.height);
               ctx.drawImage(img, curImgPos.x, curImgPos.y, img.width, img.height);
            },
            end: function(e){
               initImgPos.x = curImgPos.x;
               initImgPos.y = curImgPos.y;
            }
        });
//        双指缩放
        gesture({
            el: canvas,
            start: function(e){
                imgbox.innerHTML += img.width + " " +img.height;
            },
            change: function(e){
                curImgPos.scale = e.scale;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, initImgPos.x - (curImgPos.scale-1)*img.width, initImgPos.y-(curImgPos.scale-1)*img.height, img.width*curImgPos.scale, img.height*curImgPos.scale);
            },
            end: function(e){
                initImgPos.x = initImgPos.x - (curImgPos.scale-1)*img.width;
                initImgPos.y = initImgPos.y - (curImgPos.scale-1)*img.height;
                img.width = img.width*curImgPos.scale;
                img.height = img.height*curImgPos.scale;
//                ctx.clearRect(0, 0, canvas.width, canvas.height);
//                ctx.drawImage(img, initImgPos.x - (curImgPos.scale-1)*img.width, initImgPos.y-(curImgPos.scale-1)*img.height, img.width*curImgPos.scale, img.height*curImgPos.scale);
                imgbox.innerHTML += "&&"+img.width + " " +img.height+"||";
            }
        })
    }

//    单指拖动
//    init:{
//        el: 操作元素，
//        start: fn , 开始单指拖动
//        move: fn, 单指拖动中函数
//        end: fn 单指拖动结束函数
//    }
//    专为图片预览编辑而做的拖动
    function singleDrag(init){
        var el = init.el;
        var startPos = {};
        var ifSingleDrag = false;
        el.addEventListener('touchstart', function(e){
            if(e.touches.length < 2){
                ifSingleDrag = true;
                startPos ={
                    x: e.targetTouches[0].pageX,
                    y: e.targetTouches[0].pageY
                };
                init.start&&init.start.apply(el, e);
            }
        });
        el.addEventListener('touchmove', function(e){
            if(ifSingleDrag){
                var curPos = {
                    x: e.targetTouches[0].pageX,
                    y: e.targetTouches[0].pageY
                };
                e.change = {
                    x : curPos.x - startPos.x,
                    y : curPos.y - startPos.y
                };
                init.move&&init.move.call(el, e);
            }
        });
        el.addEventListener('touchend', function(e){
            if(ifSingleDrag){
                init.end&&init.end.call(el, e);
                ifSingleDrag = false;
            }
        });
    }

    function onlyDrag(init){
        var el = init.el;
        var startPos = {};
        var startElPos = {};
        el.addEventListener('touchstart', function(e){
            if(e.touches.length < 2){
                ifSingleDrag = true;
                startPos = {
                    x: e.targetTouches[0].pageX,
                    y: e.targetTouches[0].pageY
                };
                startElPos = {
                    x : parseFloat(css(el,'translateX')),
                    y :  parseFloat(css(el,'translateY'))
                }
            }
        });
        el.addEventListener('touchmove', function(e){
            if(ifSingleDrag){
                var curPos = {
                    x: e.targetTouches[0].pageX,
                    y: e.targetTouches[0].pageY
                };
                css(el,'translateX',startElPos.x + curPos.x-startPos.x+'px');
                css(el,'translateY',startElPos.y + curPos.y-startPos.y+'px');
                e.changePos = {
                    x : curPos.x - startPos.x,
                    y : curPos.y - startPos.y
                };
                init.move&&init.move.call(el, e);
            }
        });
        el.addEventListener('touchend', function(e){
            if(ifSingleDrag){
                init.end&&init.end.call(el, e);
            }
        });
    }
</script>
</body>
</html>